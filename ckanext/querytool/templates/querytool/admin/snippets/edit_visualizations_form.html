{% import 'macros/form.html' as form %}

{% resource 'querytool/vendor/c3/c3.css' %}
{% resource 'querytool/vendor/d3/d3.js' %}
{% resource 'querytool/vendor/c3/c3.js' %}
{% resource 'querytool/javascript/visualizations_settings.js' %}
{% resource 'querytool/javascript/modules/viz-preview.js' %}
{% resource 'querytool/map' %}
{% resource 'querytool/table' %}

{% set ctrl = 'ckanext.querytool.controllers.querytool:QueryToolController' %}
{% if data %}
{% set name = data.name %}
{% else %}
{% set name = '' %}
{% endif %}

{% set action_url = h.url_for('querytool_edit_visualizations', querytool= '/' + name) %}
{% set edit_data_url = h.url_for('querytool_edit', querytool='/' + name) %}

{% set y_axis_values = [] %}
{% for item in data.y_axis_columns %}
  {% do y_axis_values.append(item.value) %}
{% endfor %}

<form method="post" action="{{ action_url }}" data-y-axis-values="{{ y_axis_values }}" data-sql-string="{{ data.sql_string }}" data-chart-resource="{{ data.chart_resource }}" data-map-resource="{{ data.map_resource }}" class="form-horizontal col-sm-12" id="visualizations-form" enctype='multipart/form-data'>
  {% block stages %}
  {% snippet 'querytool/admin/snippets/stages.html', stages=['complete', 'active'] %}
  {% endblock %}

  {% block error_summary %}
  {{ form.errors(error_summary) }}
  {% endblock %}
  {% block charts %}
  <legend class="sticky-title">{{ _('Data visualizations') }}
    <ul class="inline pull-right">
      <li><a class="btn" href="{{ edit_data_url}}" type="submit" name="edit"><span class="fa fa-pencil" aria-hidden="true"></span> {{ _('Edit data') }}</a></li>
      <li><button id="save-visualization-btn" type="submit" class="btn btn-success" name="save">{{ _('Save') }}</button></li>
    </ul>
  </legend>
  {% if data.visualizations %}
    {% set selected_y_axis_column = data.y_axis_column %}
  {% endif %}
  <div class="chart-global-controls">
    {{ form.select('choose_y_axis_column', 'choose_y_axis_column', _('Y axis column'), options=data.y_axis_columns, selected=selected_y_axis_column) }}
  </div>

  <fieldset>
    <div id="choose-y-axis-column-container">
      <ul class="inline">
        <li>
          {{ form.select('item_type', 'item_type', _('Visualization type'), options=[{'value': '', 'text': '— Select type —'}, {'value': 'chart', 'text': 'Chart'}, {'value': 'map', 'text': 'Map'}, {'value':'text-box', 'text': 'Text box'},{'value':'image', 'text': 'Image'}, {'value':'table', 'text':'Table'}]) }}
        </li>
        <li>
          <a id="add-visualization-btn" class="btn btn-info" style="display: {{ btn_display  }}"><span class="fa fa-plus-square"></span> {{ _('Add visualization') }}</a>
        </li>
      </ul>
      <div class="hidden" id="visualization-info-msg">
        <span>Some msg</span>
      </div>
    </div>
  </fieldset>
  <fieldset id="visualization-settings-items" class="visualizations">
    {% for item in data.visualizations %}
      {% if item.type == 'chart'  %}
        {% snippet 'ajax_snippets/chart_item.html',
          n = item.order,
          chart = item,
          sql_string = data.sql_string,
          map_resource = data.map_resource,
          chart_resource = data.chart_resource,
          y_axis_values = y_axis_values
        %}
      {% endif %}
      {% if item.type == 'text_box'  %}
        {% snippet 'ajax_snippets/text_box_item.html',
          n = item.order,
          box = item
        %}
      {% endif %}
      {% if item.type == 'image'  %}
        {% snippet 'ajax_snippets/image_item.html',
          n = item.order,
          data = item
        %}
      {% endif %}
      {% if item.type == 'map'  %}
        {% snippet 'ajax_snippets/map_item.html',
          n = item.order,
          map = item,
          sql_string = data.sql_string,
          chart_resource = data.chart_resource,
          y_axis_column = data.y_axis_column,
          map_color_scheme = data.map_color_scheme,
          y_axis_values = y_axis_values
        %}
      {% endif %}
     {% if item.type == 'table'  %}
        {% snippet 'ajax_snippets/table_item.html',
          n = item.order,
          table = item,
          sql_string = data.sql_string,
          resource_id = data.chart_resource,
          y_axis = data.y_axis_column,
          y_axis_values = y_axis_values
        %}
      {% endif %}
    {% endfor %}
  </fieldset>

{% endblock %}
</form>
